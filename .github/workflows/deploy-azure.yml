name: Azure Deployment

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  REGISTRY_URL: ${{ secrets.AZURE_REGISTRY_URL }}
  REGISTRY_USERNAME: ${{ secrets.AZURE_REGISTRY_USERNAME }}
  REGISTRY_PASSWORD: ${{ secrets.AZURE_REGISTRY_PASSWORD }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Docker Login
        run: |
          echo "${{ secrets.AZURE_REGISTRY_PASSWORD }}" | docker login -u "${{ secrets.AZURE_REGISTRY_USERNAME }}" --password-stdin "${{ secrets.AZURE_REGISTRY_URL }}"

      - name: Build Java services
        shell: bash
        run: |
          for service in api-gateway eureka_server order_service payment_service product_service restaurant-service user_service drone_service; do
            echo "Building $service..."
            cd DoAnCNPM_Backend/$service
            docker build -t "${{ secrets.AZURE_REGISTRY_URL }}/${service}:latest" .
            docker push "${{ secrets.AZURE_REGISTRY_URL }}/${service}:latest"
            cd ../../
          done

      - name: Build React web
        shell: bash
        run: |
          cd DoAnCNPM_Frontend/web
          npm install --legacy-peer-deps
          docker build -t "${{ secrets.AZURE_REGISTRY_URL }}/web:latest" .
          docker push "${{ secrets.AZURE_REGISTRY_URL }}/web:latest"

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy infrastructure
        shell: bash
        run: |
          az deployment group create \
            --name "fastfood-infra-$(date +%s)" \
            --resource-group "fastfood-rg" \
            --template-file "infra/main.bicep" \
            --parameters location="eastasia" environmentName="prod"

      - name: Deploy services
        shell: bash
        run: |
          az deployment group create \
            --name "fastfood-apps-$(date +%s)" \
            --resource-group "fastfood-rg" \
            --template-file "infra/containerApps.bicep" \
            --parameters \
              location="eastasia" \
              containerRegistryUrl="${{ secrets.AZURE_REGISTRY_URL }}" \
              containerRegistryUsername="${{ secrets.AZURE_REGISTRY_USERNAME }}" \
              containerRegistryPassword="${{ secrets.AZURE_REGISTRY_PASSWORD }}"

