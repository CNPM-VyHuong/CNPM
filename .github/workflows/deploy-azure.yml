name: Azure Deployment

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  REGISTRY: ${{ secrets.AZURE_REGISTRY_URL }}
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  AZURE_RESOURCE_GROUP: fastfood-rg
  AZURE_REGION: eastasia

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Log in to Azure Container Registry
        uses: azure/docker-login@v1
        with:
          login-server: ${{ secrets.AZURE_REGISTRY_URL }}
          username: ${{ secrets.AZURE_REGISTRY_USERNAME }}
          password: ${{ secrets.AZURE_REGISTRY_PASSWORD }}

      - name: Build and push Java services
        run: |
          services=(
            "api-gateway"
            "eureka_server"
            "order_service"
            "payment_service"
            "product_service"
            "restaurant-service"
            "user_service"
            "drone_service"
          )
          
          for service in "${services[@]}"; do
            echo "Building $service..."
            cd DoAnCNPM_Backend/$service
            docker build -t ${{ secrets.AZURE_REGISTRY_URL }}/${service}:latest .
            docker push ${{ secrets.AZURE_REGISTRY_URL }}/${service}:latest
            cd ../../
          done

      - name: Build and push React web app
        run: |
          echo "Building React web app..."
          cd DoAnCNPM_Frontend/web
          docker build -t ${{ secrets.AZURE_REGISTRY_URL }}/web:latest .
          docker push ${{ secrets.AZURE_REGISTRY_URL }}/web:latest
          cd ../../

      - name: Azure CLI login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy infrastructure with Bicep
        run: |
          az deployment group create \
            --name fastfood-infra-$(date +%Y%m%d%H%M%S) \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --template-file infra/main.bicep \
            --parameters location=${{ env.AZURE_REGION }} environmentName=prod

      - name: Deploy Container Apps
        run: |
          az deployment group create \
            --name fastfood-apps-$(date +%Y%m%d%H%M%S) \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --template-file infra/containerApps.bicep \
            --parameters \
              location=${{ env.AZURE_REGION }} \
              containerRegistryUrl=${{ secrets.AZURE_REGISTRY_URL }} \
              containerRegistryUsername=${{ secrets.AZURE_REGISTRY_USERNAME }} \
              containerRegistryPassword=${{ secrets.AZURE_REGISTRY_PASSWORD }}

      - name: Get deployment info
        run: |
          echo "Deployment completed!"
          az containerapp show --name fastfood-api-gateway --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --query properties.configuration.ingress.fqdn
